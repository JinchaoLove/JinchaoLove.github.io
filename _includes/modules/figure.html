{%- assign img_path = include.path
  | remove: '.jpg'
  | remove: '.jpeg'
  | remove: '.png'
  | remove: '.tiff'
  | remove: '.gif'
-%}

{% if img_path contains '://' %}
  {% assign is_relative_url = false %}
  {% assign img_src=include.path %}
{% else %}
  {% assign is_relative_url = true %}
  {% assign img_src=include.path | relative_url %}
{% endif %}

{% if include.zoomable %}
<a href="{{ img_src }}" class="popup img-link" title="{{ include.alt }}">
{% endif %}
<figure>
  <picture>
    <!-- Auto scaling with imagemagick -->
    {% if site.imagemagick.enabled and is_relative_url %}
      <source
        class="responsive-img-srcset"
        srcset="
          {% for i in site.imagemagick.widths -%}
            {{ img_path | relative_url }}-{{ i }}.webp {{i}}w,
          {% endfor -%}
        "
        {% if include.lqip %}
          lqip="{{ include.lqip }}"
        {% endif %}
        {% if include.sizes %}
          sizes="{{ include.sizes }}"
        {% else %}
          sizes="95vw"
        {% endif %}
        type="image/webp"
        loading="lazy"
        data-proofer-ignore
      >
    {% endif %}

    <!-- Fallback to the original file -->
    <img
      {% if is_relative_url %}
        src="{{ include.path | relative_url }}"
      {% else %}
        src="{{ include.path }}"
      {% endif %}
      {% if include.class %}
        class="{{ include.class }}"
      {% endif %}
      {% if include.lqip %}
        lqip="{{ include.lqip }}"
      {% endif %}
      {% if include.width %}
        width="{{ include.width }}"
      {% else %}
        width="100%"
      {% endif %}
      {% if include.height %}
        height="{{ include.height }}"
      {% else %}
        height="auto"
      {% endif %}
      {% if include['min-width'] or include['min-height'] or include['max-width'] or include['max-height'] %}
        style="
          {% if include['min-width'] %}
            min-width: {{ include.min-width }};
          {% endif %}
          {% if include['min-height'] %}
            min-height: {{ include.min-height }};
          {% endif %}
          {% if include['max-width'] %}
            max-width: {{ include.max-width }};
          {% endif %}
          {% if include['max-height'] %}
            max-height: {{ include.max-height }};
          {% endif %}
        "
      {% endif %}
      alt="{{ include.alt }}"
      {% if include.title %}
        title="{{ include.title }}"
      {% endif %}
      {% if include.zoomable %}
        data-zoomable
      {% endif %}
      {% if include.loading %}
        loading="{{ include.loading }}"
      {% else %}
        loading="lazy"
      {% endif %}
      {% if include.decoding %}
        decoding="{{ include.decoding }}"
      {% else %}
        decoding="async"
      {% endif %}
      {% comment %} onerror="this.onerror=null;$('.responsive-img-srcset').remove();" {% endcomment %}
      onerror="this.onerror=null;Array.from(this.parentNode.querySelectorAll('source')).forEach(el => el.remove());">
    >
  </picture>

  {%- if include.caption -%}
    <figcaption class="text-center pt-2 pb-2">{{ include.caption }}</figcaption>
  {%- endif %}
</figure>
{% if include.zoomable %}
  </a>
{% endif %}
